---
title: "Stock Orders"
author: "Lela Sengupta"
format: html
execute: 
  echo: false
---

```{r}
#| label: setup
#| message: false
library(tidyverse)
library(brms)
library(tidybayes)
library(gtsummary)
```

```{r}
#| label: data_load
#| message: false

security <- read_csv("q1_2024_all.csv") |> 
  janitor::clean_names() |>
   mutate(volatility_rank = 
            case_when(volatility_rank %in% c(1,4) ~ "low",
    volatility_rank %in% c(5,7) ~ "mid" ,
    volatility_rank %in% c(8,10) ~ "high"))|>
  select(security, ticker, volatility_rank, hidden, date) |>
  filter(hidden > 0, date == 20240207, security == "Stock") |>
  drop_na() 


```


```{r}
#| label: model
#| cache: true

fit_sec5 <- brm(formula = hidden ~ volatility_rank,
    data = security,
    family = gaussian(),
    silent = 2,
    refresh = 0,
    seed = 9)
```


```{r}
#| label: plot
fit_sec5 |> 
  add_epred_draws(newdata = tibble(volatility_rank = c("low", "mid", "high"))) |> 
  ggplot(aes(x = .epred, fill = volatility_rank)) + 
    geom_histogram(aes(y = after_stat(count/sum(count))),
                   bins = 100, alpha = 0.7) + 
    scale_y_continuous(labels = scales::percent_format()) +
    theme_classic() +
  labs(title = "Posterior for Amount of Hidden Orders per Stock",
       subtitle = "Stocks with low volatility experience a wide range of hidden orders",
       x = "Number of Hidden Orders",
       y = "Probability",
       fill = "Volatility")
```

q: what types of stocks experience the most hidden orders?
specific q: in the US stock market, on a typical trading day, will highly volatile stocks experience larger amounts of hidden orders than moderately or less volatile stocks?

preceptor table:
type of question: predictive -- # of hidden orders is one outcome
outcome: number of hidden orders (Hidden)
covariates: volatility ranking (1-10), date, security type, could do another one with market cap rank
units: individual US securities
family: gaussian
time: near future --> 2024-2050

validity: 
- volatility columns are not the same between the preceptor table and the data: the sec and individual investors might have different methods to determine what makes a stock volatile, making measurements different

pop table:
time: 2010 - 2050
source: different stock indexes, government organizations
units: individual securities
outcomes and covariates are the same

stability:
- trends in investing and sec regulations, as well as their rating system, change over time
representativeness:
- data only covers publicly traded securities, correlations between volatility and hidden orders could be different with privately traded securities
unconfoundedness:
- this is predictive

- model: 5, picked specific date, filtered out etfs
- for model 6: filter outliers, add slope 
